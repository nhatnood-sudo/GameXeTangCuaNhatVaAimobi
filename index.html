<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Red Tank: Landscape Survival</title>
    <style>
        :root {
            --player: #ff0000; /* Đỏ rực */
            --zombie: #27ae60; /* Xanh lá */
            --bg: #bdc3c7;     /* Nền sáng */
            --wall: #34495e;
            --accent: #f1c40f;
        }
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        
        #gameWrapper { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--bg); }
        
        canvas { display: block; background: var(--bg); max-width: 100%; max-height: 100%; object-fit: contain; }

        /* UI */
        #ui { position: absolute; top: 10px; width: 100%; display: flex; justify-content: center; gap: 15px; color: #000; font-weight: bold; pointer-events: none; z-index: 10; }
        
        /* Joystick */
        #joyZone { position: absolute; bottom: 30px; left: 30px; width: 140px; height: 140px; }
        .joy-base { width: 100%; height: 100%; background: rgba(0,0,0,0.1); border: 2px solid #000; border-radius: 50%; position: relative; }
        .joy-stick { width: 50px; height: 50px; background: #000; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* Shoot */
        #shootBtn { position: absolute; bottom: 40px; right: 40px; width: 90px; height: 90px; background: var(--player); border: 4px solid #fff; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* Menu */
        #menu { position: absolute; inset: 0; background: rgba(255,255,255,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn { padding: 15px 40px; margin: 10px; border: none; border-radius: 30px; font-weight: bold; font-size: 18px; color: white; background: #2c3e50; cursor: pointer; width: 250px; }
        .btn-red { background: var(--player); }
    </style>
</head>
<body>

<div id="gameWrapper">
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui">
        <span>ĐIỂM: <span id="sc">0</span></span>
        <span>MÁU: <span id="hp">5</span></span>
        <span>SÚNG LV: <span id="lv">1</span></span>
    </div>

    <div id="joyZone"><div class="joy-base"><div class="joy-stick" id="stick"></div></div></div>
    <div id="shootBtn">BẮN</div>

    <div id="menu">
        <h1 style="color:var(--player); font-size: 32px;">RED TANK MOBILE</h1>
        <button class="btn btn-red" onclick="start(true)">XOAY NGANG & CHƠI</button>
        <button class="btn" onclick="start(false)">CHẾ ĐỘ CỬA SỔ</button>
        <p style="font-size: 12px; color: #666;">*Nếu không xoay ngang, hãy bật 'Tự động xoay' trên điện thoại</p>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = 800; canvas.height = 450;

const GRID = 50; 
const WALL_THICK = 10; // Tường siêu mỏng để không bị kẹt
const TANK_R = 12;      // Nhân vật nhỏ lại

let active = false;
let score = 0, frame = 0;
let player, enemies = [], bullets = [], items = [];
let joy = { active: false, x: 0, y: 0, ang: 0 };
let shooting = false;

const map = [
    "1111111111111111",
    "1000000000000001",
    "1011000000001101",
    "1000000110000001",
    "1011000000001101",
    "1000000000000001",
    "1000011111100001",
    "1000000000000001",
    "1111111111111111"
];

/* --- ÉP XOAY MÀN HÌNH --- */
async function lockOrientation() {
    try {
        if (document.documentElement.requestFullscreen) {
            await document.documentElement.requestFullscreen();
        }
        if (screen.orientation && screen.orientation.lock) {
            await screen.orientation.lock('landscape');
        }
    } catch (e) {
        console.log("Không thể ép xoay ngang tự động:", e);
    }
}

/* --- VẬT LÝ VA CHẠM --- */
function isWall(x, y) {
    let gx = Math.floor(x / GRID), gy = Math.floor(y / GRID);
    if (!map[gy] || map[gy][gx] !== '1') return false;
    
    // Kiểm tra va chạm với tường mỏng ở giữa ô
    let wx = gx * GRID + (GRID - WALL_THICK)/2;
    let wy = gy * GRID + (GRID - WALL_THICK)/2;
    return (x > wx && x < wx + WALL_THICK && y > wy && y < wy + WALL_THICK);
}

// Hàm di chuyển trượt để chống kẹt
function moveEntity(ent, vx, vy) {
    if (!isWall(ent.x + vx, ent.y)) ent.x += vx;
    if (!isWall(ent.x, ent.y + vy)) ent.y += vy;
}

class Tank {
    constructor() { this.x = 100; this.y = 100; this.hp = 5; this.lv = 1; this.ang = 0; this.cd = 0; }
    update() {
        if (joy.active) {
            this.ang = joy.ang;
            moveEntity(this, Math.cos(this.ang)*3.5, Math.sin(this.ang)*3.5);
        }
        if (this.cd > 0) this.cd--;
        if (shooting && this.cd <= 0) this.shoot();
        
        items = items.filter(it => {
            if (Math.hypot(this.x-it.x, this.y-it.y) < 25) { this.lv++; return false; }
            return true;
        });
    }
    shoot() {
        let n = this.lv >= 3 ? 3 : 1;
        for(let i=0; i<n; i++) {
            bullets.push({x:this.x, y:this.y, a:this.ang + (i-Math.floor(n/2))*0.2, life:100});
        }
        this.cd = 15;
    }
    draw() {
        ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.ang);
        ctx.fillStyle = "var(--player)"; ctx.beginPath(); ctx.arc(0,0,TANK_R,0,Math.PI*2); ctx.fill();
        ctx.fillStyle = "#000"; ctx.fillRect(0,-3,18,6); ctx.restore();
    }
}

class Zombie {
    constructor() {
        this.x = Math.random() > 0.5 ? 50 : 750;
        this.y = Math.random() * 400;
        this.hp = 2;
    }
    update() {
        let a = Math.atan2(player.y - this.y, player.x - this.x);
        moveEntity(this, Math.cos(a)*1.5, Math.sin(a)*1.5);
        if (Math.hypot(player.x-this.x, player.y-this.y) < 25) player.hp -= 0.02;
    }
    draw() {
        ctx.fillStyle = "var(--zombie)"; ctx.beginPath(); ctx.arc(this.x, this.y, 14, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(this.x-4, this.y-4, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(this.x+4, this.y-4, 3, 0, Math.PI*2); ctx.fill();
    }
}

/* --- ĐIỀU KHIỂN --- */
const stick = document.getElementById('stick');
const joyZone = document.getElementById('joyZone');

function handleJoy(ex, ey, end) {
    if (end) { joy.active = false; stick.style.transform = `translate(-50%,-50%)`; return; }
    let r = joyZone.getBoundingClientRect();
    let dx = ex - (r.left + 70), dy = ey - (r.top + 70);
    let d = Math.min(Math.sqrt(dx*dx+dy*dy), 50);
    joy.active = true; joy.ang = Math.atan2(dy, dx);
    stick.style.transform = `translate(calc(-50% + ${(dx/d)*d}px), calc(-50% + ${(dy/d)*d}px))`;
}

joyZone.ontouchstart = e => handleJoy(e.touches[0].clientX, e.touches[0].clientY);
joyZone.ontouchmove = e => { e.preventDefault(); handleJoy(e.touches[0].clientX, e.touches[0].clientY); };
joyZone.ontouchend = () => handleJoy(0,0,true);
document.getElementById('shootBtn').ontouchstart = () => shooting = true;
document.getElementById('shootBtn').ontouchend = () => shooting = false;

/* --- VÒNG LẶP --- */
async function start(f) {
    if (f) await lockOrientation();
    document.getElementById('menu').style.display = 'none';
    player = new Tank(); enemies = []; bullets = []; items = []; score = 0;
    active = true; loop();
}

function loop() {
    if (!active) return;
    ctx.clearRect(0,0,800,450); frame++;

    // Vẽ Map
    ctx.fillStyle = "var(--wall)";
    map.forEach((row, y) => row.split('').forEach((c, x) => {
        if(c==='1') ctx.fillRect(x*GRID+(GRID-WALL_THICK)/2, y*GRID+(GRID-WALL_THICK)/2, WALL_THICK, WALL_THICK);
    }));

    player.update(); player.draw();

    if (frame % 80 === 0) enemies.push(new Zombie());
    enemies.forEach((z, i) => {
        z.update(); z.draw();
        if (z.hp <= 0) { 
            enemies.splice(i, 1); score += 10; 
            if(Math.random()<0.1) items.push({x:z.x, y:z.y});
        }
    });

    bullets = bullets.filter(b => {
        b.x += Math.cos(b.a)*8; b.y += Math.sin(b.a)*8; b.life--;
        ctx.fillStyle = "yellow"; ctx.beginPath(); ctx.arc(b.x, b.y, 3, 0, Math.PI*2); ctx.fill();
        enemies.forEach(z => { if(Math.hypot(b.x-z.x, b.y-z.y)<15){ z.hp--; b.life=0; }});
        return b.life > 0 && !isWall(b.x, b.y);
    });

    items.forEach(it => { ctx.fillStyle = "cyan"; ctx.fillRect(it.x-8, it.y-8, 16, 16); });

    document.getElementById('sc').innerText = score;
    document.getElementById('hp').innerText = Math.ceil(player.hp);
    document.getElementById('lv').innerText = player.lv;

    if (player.hp <= 0) {
        active = false;
        alert("BẠN ĐÃ THUA! SCORE: " + score);
        document.getElementById('menu').style.display = 'flex'; // Quay về menu không reload
    } else {
        requestAnimationFrame(loop);
    }
}
</script>
</body>
</html>
